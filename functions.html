<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="UTF-8">
<title>Function Tests</title>
<link rel="stylesheet" href="https://dev.mavo.io/dist/mavo.css" />
<link rel="stylesheet" href="style.css" />
<style>
td {
	font: bold 100%/1.5 Consolas, Monaco, monospace;
}
table.reftest td:first-child {
	flex: 2;
}
</style>
<script src="https://dev.mavo.io/dist/mavo.js"></script>
<script src="mavotest.js"></script>
</head>
<body>

<h1>Function Tests</h1>

<p>These tests test whether Mavo functions produce correct results.</p>

<section>
	<h1>Basic Operators</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>addition("1", 1)</td>
			<td>2</td>
		</tr>
		<tr>
			<td>addition("", "")</td>
			<td>0</td>
		</tr>
		<tr>
			<td>addition("3", "5")</td>
			<td>8</td>
		</tr>
		<tr>
			<td>addition([1, 2, 3])</td>
			<td>6</td>
		</tr>
		<tr>
			<td>addition([1, 2, 3], [4, 5])</td>
			<td>[5, 7, 3]</td>
		</tr>
		<tr>
			<td>subtract(1, 2)</td>
			<td>-1</td>
		</tr>
		<tr>
			<td>subtract(1, -2)</td>
			<td>3</td>
		</tr>
		<tr>
			<td>subtract(1, 0)</td>
			<td>1</td>
		</tr>
		<tr>
			<td>minus(1)</td>
			<td>-1</td>
		</tr>
		<tr>
			<td>and(0, true)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>and([0, 1, 2, 3], [true, false])</td>
			<td>[false, false, 2, 3]</td>
		</tr>
		<tr>
			<td>and([true, false], [0, 1, 2, 3])</td>
			<td>[false, false, true, true]</td>
		</tr>
		<tr>
			<td>or(true, false, false)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>or(false, false, false)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>eq(3, 3, 3, 3)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>eq("l","l")</td>
			<td>true</td>
		</tr>
		<tr>
			<td>gt(3, 2, 1)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>lt(1, 2, 3)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>lt(1, 2, 1)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>gt(3, 2, 3)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>gt("2090-06-13", $now)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>gt("1990-06-13", $now)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>neq(2, 2)</td>
			<td>false</td>
		</tr>
		<tr>
			<td>neq(foo, bar)</td>
			<td>true</td>
		</tr>
		<tr>
			<td>neq(2, 2, 3)</td>
			<td>false</td>
		</tr>
	</table>
</section>

<section>
	<h1>Objects</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>group(name: 'Lea', age: 32)</td>
			<td>{"name":"Lea","age":32}</td>
		</tr>
		<tr>
			<td>list(1, 2, 3)</td>
			<td>[1, 2, 3]</td>
		</tr>
	</table>
</section>

<section>
	<h1>Aggregates</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>average(null, 1, 2, 3, null, "")</td>
			<td>2</td>
		</tr>
		<tr>
			<td>average([null, 1, 2, 3, null, ""])</td>
			<td>2</td>
		</tr>
	</table>
</section>

<section>
	<h1>iff()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>iff(4, 1, 2)</td>
			<td>1</td>
		</tr>
		<tr>
			<td>iff([1, 0], 1, 2)</td>
			<td>[1, 2]</td>
		</tr>
		<tr>
			<td>iff([1, 0], [1, 2], [3, 4])</td>
			<td>[1, 4]</td>
		</tr>
		<tr>
			<td>iff([true, false, 0, 1], 1, [2, 3])</td>
			<td>[1, 3, 3, 1]</td>
		</tr>
	</table>
</section>

<section>
	<h1>Concatenation</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>"yolo" & 2</td>
			<td>"yolo2"</td>
		</tr>
		<tr>
			<td>[1, "hello"] & "#"</td>
			<td>["1#", "hello#"]</td>
		</tr>
		<tr>
			<td>[1, 2, 3] & "#" & ["a", "b", "c"]</td>
			<td>["1#a", "2#b", "3#c"]</td>
		</tr>
	</table>
</section>

<section>
	<h1>get()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>get({bar: 4}, "bar")</td>
			<td>4</td>
		</tr>
		<tr>
			<td>get({}, "bar")</td>
			<td>null</td>
		</tr>
		<tr>
			<td>get(null, "bar")</td>
			<td>null</td>
		</tr>
		<tr title="Case insensitive lookup">
			<td>get({foo: 1, foO: 2}, "FOO")</td>
			<td>1</td>
		</tr>
		<tr title="Case insensitive lookup, priority to correct case">
			<td>get({foo: 1, foO: 2}, "foO")</td>
			<td>2</td>
		</tr>
		<tr title="undefined">
			<td>get({foo: undefined}, "foo")</td>
			<td>undefined</td>
		</tr>
		<tr title="undefined and case insensitive">
			<td>get({foo: undefined, foO: 1}, "foo")</td>
			<td>undefined</td>
		</tr>
		<tr title="Get collection item by id">
			<td>get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "id=foo").name</td>
			<td>"fooname"</td>
		</tr>
		<tr title="Get collection item by id">
			<td>get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "id=bar").name</td>
			<td>"barname"</td>
		</tr>
		<tr title="Get collection item by name">
			<td>get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "name=fooname")</td>
			<td>[{"id":"foo","name":"fooname"}]</td>
		</tr>
		<tr title="Get collection item property">
			<td>get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "name")</td>
			<td>["fooname", "barname"]</td>
		</tr>
		<tr title="Get collection item by name and then by property">
			<td>get(get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "name=barname"), "id")</td>
			<td>["bar"]</td>
		</tr>
	</table>
</section>

<section>
	<h1>get() meta</h1>

	<table class="reftest">
		<tr title="Normal">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get({id: "foo", name: "fooname"}, "id", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				"id"
			</td>
		</tr>
		<tr title="Not found">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get({id: "foo", name: "fooname"}, "yolo", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				"yolo"
			</td>
		</tr>
		<tr title="Case insensitive">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get({id: "foo", name: "fooname"}, "ID", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				"id"
			</td>
		</tr>
		<tr title="Array, Get by id">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "id=bar", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				1
			</td>
		</tr>
		<tr title="Array, Get by id (nonexistent)">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "id=yolo", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				2
			</td>
		</tr>
		<tr title="Array, Get by name">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "name=barname", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				[1]
			</td>
		</tr>
		<tr title="Array, Get by name (nonexistent)">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}], "name=yolo", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				[2]
			</td>
		</tr>
		<tr title="Array, Get by name (multiple)">
			<td>
				<script>
					var meta = {};
					Mavo.Functions.get([{id: "foo", name: "fooname"}, {id: "bar", name: "barname"}, {id: "foo2", name: "fooname"}], "name=fooname", meta);
					print(JSON.stringify(meta.property));
				</script>
			</td>
			<td>
				[0,2]
			</td>
		</tr>
	</table>
</section>

<section>
	<h1>String slicing</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>from("foo", ".")</td>
			<td>""</td>
		</tr>
		<tr>
			<td>from("foo.bar", ".")</td>
			<td>"bar"</td>
		</tr>
		<tr>
			<td>from("foo.bar.baz", ".")</td>
			<td>"bar.baz"</td>
		</tr>
		<tr>
			<td>fromlast("foo.bar.baz", ".")</td>
			<td>"baz"</td>
		</tr>
		<tr>
			<td>to("foo", ".")</td>
			<td>""</td>
		</tr>
		<tr>
			<td>to("foo.bar", ".")</td>
			<td>"foo"</td>
		</tr>
		<tr>
			<td>to("foo.bar.baz", ".")</td>
			<td>"foo.bar"</td>
		</tr>
		<tr>
			<td>tofirst("foo.bar.baz", ".")</td>
			<td>"foo"</td>
		</tr>
		<tr>
			<td>between("foo.bar.baz", ".", ".")</td>
			<td>"bar"</td>
		</tr>
		<tr>
			<td>between("foo.bar.baz", "#", "$")</td>
			<td>""</td>
		</tr>
	</table>
</section>

<section>
    <h1>contains()</h1>

    <table class="reftest" data-test="expressionEvaluation" data-columns="3">
        <tr>
            <td>contains("0", 0)</td>
            <td>true</td>
		</tr>
		<tr>
            <td>
                contains({name: "Kenneth", age: 17, state: "constant despair", work: "MIT", interest: ["coding", {food: "rice", quantity: 6}, "sleeping"]}, "rice")
            </td>
            <td>true</td>
		</tr>
        <tr>
            <td>
                contains(["Lea", "Kenneth", "Amy", "Kenneth"], "Kenneth")
            </td>
            <td>[false,true,false,true]</td>
		</tr>
		<tr>
            <td>
                contains(["Kenneth", "MIT", {name: "Kenneth", food: "rice", quantity: 6}, "sleeping"], "Kenneth")
            </td>
            <td>[true,false,true,false]</td>
		</tr>
		<tr>
			<td>
				contains(["Kenneth", "MIT", ["Kenneth", 6], "sleeping"], "Kenneth")
			</td>
			<td>[true,false,true,false]</td>
		</tr>
		<tr>
            <td>
                contains({name: "Kenneth", work: "MIT", interest: ["coding", {food: "rice", quantity: 6}, "sleeping"]}, {name: "Kenneth", work: "MIT"})
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains(["Kenneth", "MIT", {name: "Kenneth", food: "rice", quantity: 6}, "sleeping"], {name: "Kenneth", work: "MIT"})
            </td>
            <td>[false,false,false,false]</td>
		</tr>
		<tr>
			<td>
				contains("Kenneth", ["Kenneth", "Lea"])
			</td>
			<td>[true,false]</td>
		</tr>
		<tr>
			<td>
				contains(["Kenneth", "Verou"], ["Kenneth", "Lea"])
			</td>
			<td>[true, false]</td>
		</tr>
		<tr>
			<td>
				contains(["Kenneth", "Lea", "Amy", "Kenneth"], ["Kenneth", "Lea"])
			</td>
			<td>[true, true]</td>
		</tr>
		<tr>
			<td>
				contains([["Kenneth", "Lea"], "Amy", "Kenneth"], ["Kenneth", "Lea"])
			</td>
			<td>[true,false,false,false]</td>
		</tr>
		<tr>
			<td>
				contains(["Amy", ["Kenneth", "Lea"], "Kenneth"], ["Kenneth", "Lea"])
			</td>
			<td>[false,true,false,true]</td>
		</tr>
		<tr>
            <td>
                contains({name: "Kenneth", work: "MIT", interest: ["coding", {food: "rice", quantity: 6}, "sleeping"]}, ["Kenneth", "MIT"])
            </td>
            <td>[true,true]</td>
		</tr>
		<tr>
            <td>
                contains(["Kenneth", "MIT", {name: "Kenneth", food: "rice", quantity: 6}, "sleeping"], ["Kenneth", "MIT"])
            </td>
            <td>[true,true,false,false]</td>
        </tr>
        <tr>
            <td>
                contains(null, null)
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains("foo", null)
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains(null, "foo")
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains()
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains("foo")
            </td>
            <td>false</td>
		</tr>
		<tr>
            <td>
                contains([], "foo")
            </td>
            <td>false</td>
        </tr>
    </table>
</section>

<section>
	<h1>filter()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>filter(42, false)</td>
			<td>null</td>
		</tr>
		<tr>
			<td>filter(42, true)</td>
			<td>42</td>
		</tr>
		<tr>
			<td>filter([1, 2, 3], [false, true, false])</td>
			<td>[null, 2, null]</td>
		</tr>
		<tr>
			<td>filter([1, 2, 3], [true, true, false], [false, true, false])</td>
			<td>[null, 2, null]</td>
		</tr>
	</table>
</section>

<section>
	<h1>replace()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>replace("foooo", "o", "aa")</td>
			<td>"faaaaaaaa"</td>
		</tr>
		<tr title="Array haystack">
			<td>replace(["bar", "baz"], "a", "o")</td>
			<td>["bor", "boz"]</td>
		</tr>
		<tr title="Non-recursive replace">
			<td>replace("foooo", "oo", "o")</td>
			<td>"foo"</td>
		</tr>
		<tr title="Recursive replace">
			<td>replace("foooo", "oo", "o", 10)</td>
			<td>"fo"</td>
		</tr>
		<tr title="Recursive replace with bound">
			<td>replace("fo", "o", "oo", 2)</td>
			<td>"foooo"</td>
		</tr>
	</table>
</section>

<section>
	<h1>idify()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>idify(" Foo   ^ Bar ")</td>
			<td>"foo-bar"</td>
		</tr>
		<tr>
			<td>idify("property ↔ Collection")</td>
			<td>"property-collection"</td>
		</tr>
		<tr>
			<td>idify("pâté")</td>
			<td>"pate"</td>
		</tr>
		<tr>
			<td>idify("Chicken Liver Pâté! 😋")</td>
			<td>"chicken-liver-pate"</td>
		</tr>
	</table>
</section>


<section>
	<h1>intersects()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>intersects([1], [1])</td>
			<td>true</td>
		</tr>
		<tr>
			<td>intersects([1, 2], [1, 3])</td>
			<td>true</td>
		</tr>
		<tr>
			<td>intersects([1, 2], [3, 4])</td>
			<td>false</td>
		</tr>
	</table>
</section>


<section>
	<h1>reverse()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>reverse([1, 2, 3, 4, 5])</td>
			<td>[5, 4, 3, 2, 1]</td>
		</tr>
		<tr>
			<td>reverse([-3, 2, 0, 1, -5, 3])</td>
			<td>[3, -5, 1, 0, 2, -3]</td>
		</tr>
		<tr>
			<td>reverse(["a", "b", "c", "z"])</td>
			<td>["z", "c", "b", "a"]</td>
		</tr>
	</table>
</section>


<section>
	<h1>range()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>range(1, 10)</td>
			<td>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</td>
		</tr>
		<tr>
			<td>range(-5, 1)</td>
			<td>[-5, -4, -3, -2, -1, 0, 1]</td>
		</tr>
		<tr>
			<td>range(1, 3.5)</td>
			<td>[1, 2, 3]</td>
		</tr>
	</table>
</section>

<section>
	<h1>digits()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>digits(2, 1234.5678)</td>
			<td>"34.5678"</td>
		</tr>
		<tr>
			<td>digits(2, 0, 1234.5678)</td>
			<td>"34"</td>
		</tr>
		<tr>
			<td>digits(2, 5, 1234.5678)</td>
			<td>"34.56780"</td>
		</tr>
		<tr>
			<td>digits(2, 1)</td>
			<td>"01"</td>
		</tr>
		<tr>
			<td>digits(2, 2, 0)</td>
			<td>"00.00"</td>
		</tr>
		<tr>
			<td>digits(0)</td>
			<td>null</td>
		</tr>
	</table>
</section>

<section>
	<h1>Dates</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>day("1986-06-13")</td>
			<td>13</td>
		</tr>
		<tr>
			<td>weekday("1986-06-13")</td>
			<td>5</td>
		</tr>
		<tr>
			<td>weekday("1986-06-13").name</td>
			<td>"Friday"</td>
		</tr>
		<tr>
			<td>weekday("1986-06-13").shortname</td>
			<td>"Fri"</td>
		</tr>
		<tr>
			<td>month("1986-06-13")</td>
			<td>6</td>
		</tr>
		<tr>
			<td>digits(2, month("1986-06-13"))</td>
			<td>"06"</td>
		</tr>
		<tr>
			<td>month("1986-06-13").name</td>
			<td>"June"</td>
		</tr>
		<tr>
			<td>month("1986-06-13").shortname</td>
			<td>"Jun"</td>
		</tr>
		<tr>
			<td>year("1986-06-13")</td>
			<td>"1986"</td>
		</tr>
		<tr>
			<td>digits(2, year("1986-06-13"))</td>
			<td>"86"</td>
		</tr>
		<tr>
			<td>digits(2, year("1900-06-13"))</td>
			<td>"00"</td>
		</tr>
		<tr>
			<td>date("1986-06-03 23:15:20")</td>
			<td>"1986-06-03"</td>
		</tr>
		<tr>
			<td>time("1986-06-03 23:15:20")</td>
			<td>"23:15:20"</td>
		</tr>
		<tr>
			<td>time("1986-06-03 00:00:00")</td>
			<td>"00:00:00"</td>
		</tr>
		<tr>
			<td>hour("1986-06-13 23:15:20")</td>
			<td>23</td>
		</tr>
		<tr>
			<td>minute("1986-06-13 23:15:20")</td>
			<td>15</td>
		</tr>
		<tr>
			<td>second("1986-06-13 23:15:20")</td>
			<td>20</td>
		</tr>
		<tr title="No argument">
			<td>date()</td>
			<td>""</td>
		</tr>
		<tr title="Empty argument">
			<td>date("")</td>
			<td>""</td>
		</tr>
		<tr title="Invalid argument">
			<td>date("foobar")</td>
			<td>""</td>
		</tr>
		<tr title="No argument">
			<td>time()</td>
			<td>""</td>
		</tr>
		<tr title="Empty argument">
			<td>time("")</td>
			<td>""</td>
		</tr>
		<tr title="Invalid argument">
			<td>time("foobar")</td>
			<td>""</td>
		</tr>
		<tr title="Subtract dates">
			<td>subtract("1986-06-13", "1986-06-10")</td>
			<td>259200000</td>
		</tr>
		<tr>
			<td>days(subtract("1986-06-13", "1986-06-10"))</td>
			<td>3</td>
		</tr>
		<tr>
			<td>months(subtract("1986-06-13", "1985-01-01"))</td>
			<td>17</td>
		</tr>
	</table>
</section>

<section>
	<h1>fixDateString()</h1>

	<table class="reftest" data-test="expressionEvaluation" data-columns="3">
		<tr>
			<td>util.fixDateString("2017-11-10")</td>
			<td>"2017-11-10T00:00:00"</td>
		</tr>
		<tr>
			<td>util.fixDateString("2017-11")</td>
			<td>"2017-11-01T00:00:00"</td>
		</tr>
		<tr>
			<td>util.fixDateString("08:15")</td>
			<td>"<script>document.write((new Date().toISOString().slice(0, 10)))</script>T08:15"</td>
		</tr>
		<tr>
			<td>util.fixDateString("foobar")</td>
			<td>null</td>
		</tr>
	</table>
</section>

<script>
function expressionEvaluation(test, result, expected) {
	var r = (new Mavo.Expression(test.textContent)).eval();
	var json = JSON.stringify(r);
	result.textContent = json;
	var err;

	try {
		var evaluated = eval(expected.textContent);

		if (Test.equals(r, evaluated)) {
			return true;
		}
	}
	catch(e) {err = e}

	try {
		var stringified = JSON.stringify(JSON.parse(expected.textContent));

		if (json == stringified) {
			return true;
		}
	}
	catch(e) {err = e}

	return err || false;
}
</script>

</body>
</html>
